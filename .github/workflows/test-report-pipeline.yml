name: test-report-pipeline
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
      - uses: iterative/setup-cml@v1
      
      - name: Setup environment
        run: |
          # Your setup commands here.
          # For example:
          pip install -r requirements.txt
          pip install dvc matplotlib

      - name: Configure DVC
        run: |
          #dvc init --no-scm --force
          #dvc remote add -d storage s3://mybucket/data
          #dvc config core.autosave true
          #dvc config core.check_update false
          #echo '[user]' >> .dvc/config
          #echo '  name = github-actions' >> .dvc/config
          #echo '  email = actions@github.com' >> .dvc/config

      - name: Pull data and model
        run: |
          #dvc pull

          #- name: Run tests
          #run: |
          # Command to run your tests
          # python -m unittest

          #- name: Push results (if any)
          #run: |
          #dvc push

      - name: CML Report
        env:
          REPO_TOKEN: ${{ secrets.mysecret }}
        run: |        
          # Publish images and save the URLs
          val_dataset_iou_url=$(cml-publish Val_Dataset_IoU.png --md)
          val_image_iou_url=$(cml-publish Val_Image_IoU.png --md)
          ls
          # Create report.md
          echo "# CML Report" >> report.md
          echo "## Validation Dataset IoU" >> report.md
          echo "${val_dataset_iou_url}" >> report.md
          echo "## Validation Image IoU" >> report.md
          echo "${val_image_iou_url}" >> report.md
          # Send CML report
          cml comment create report.md

