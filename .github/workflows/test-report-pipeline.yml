name: test-report-pipeline
on: [push]
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
      - uses: iterative/setup-cml@v1
      
      - name: Setup environment
        run: |
          # Your setup commands here.
          # For example:
          pip install -r requirements.txt
          pip install dvc matplotlib

      - name: Configure DVC
        run: |
          #dvc init --no-scm --force
          #dvc remote add -d storage s3://mybucket/data
          #dvc config core.autosave true
          #dvc config core.check_update false
          #echo '[user]' >> .dvc/config
          #echo '  name = github-actions' >> .dvc/config
          #echo '  email = actions@github.com' >> .dvc/config

      - name: Pull data and model
        run: |
          #dvc pull

          #- name: Run tests
          #run: |
          # Command to run your tests
          # python -m unittest

          #- name: Push results (if any)
          #run: |
          #dvc push

      - name: CML Report
        env:
          REPO_TOKEN: ${{ secrets.mysecret }}
        run: |
          # Extract metrics from dvclive
          echo "## Metrics" >> report.md
          #dvc metrics show --all-commits --json > metrics.json
          python Pytorch-DVC-CML/segmentation_models_pytorch/generate_cml_report.py Pytorch-DVC-CML/segmentation_models_pytorch/dvclive/metrics.json >> report.md
          python Pytorch-DVC-CML/segmentation_models_pytorch/generate_plot.py Pytorch-DVC-CML/segmentation_models_pytorch/dvclive/plots/metrics/valid_dataset_iou.tsv Val_Dataset_IoU 
          python Pytorch-DVC-CML/segmentation_models_pytorch/generate_plot.py Pytorch-DVC-CML/segmentation_models_pytorch/dvclive/plots/metrics/valid_per_image_iou.tsv Val_Image_IoU
          echo '![](./Pytorch-DVC-CML/segmentation_models_pytorch/cml_reports/Val_Dataset_IoU.png "Validation IoU Dataset")' >> report.md
          echo '![](./Pytorch-DVC-CML/segmentation_models_pytorch/cml_reports/Val_Image_IoU.png "Validation IoU Image")' >> report.md
          #python format_metrics.py metrics.csv >> report.md
          # Send CML report
          cml comment create report.md

